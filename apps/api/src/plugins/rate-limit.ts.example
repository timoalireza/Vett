/**
 * Rate Limiting Plugin Template
 * 
 * Steps to implement:
 * 1. Install: pnpm --filter vett-api add @fastify/rate-limit
 * 2. Copy this file to rate-limit.ts (remove .example)
 * 3. Register this plugin in index.ts
 */

import fp from "fastify-plugin";
import type { FastifyInstance } from "fastify";
import rateLimit from "@fastify/rate-limit";
import { env } from "../env.js";

export default fp(async (fastify: FastifyInstance) => {
  // Global rate limit
  await fastify.register(rateLimit, {
    max: 100, // Maximum number of requests
    timeWindow: "1 minute", // Time window
    redis: env.NODE_ENV === "production" ? undefined : undefined, // Add Redis client for distributed rate limiting
    skipOnError: false,
    addHeaders: {
      "x-ratelimit-limit": true,
      "x-ratelimit-remaining": true,
      "x-ratelimit-reset": true,
      "retry-after": true
    }
  });

  // Stricter rate limit for GraphQL mutations
  fastify.addHook("onRequest", async (request, reply) => {
    if (request.url === "/graphql" && request.method === "POST") {
      // Check if it's a mutation
      const body = request.body as any;
      if (body?.query?.includes("mutation")) {
        // Apply stricter limits for mutations
        // You can use a separate rate limiter here
      }
    }
  });

  // Rate limit for file uploads
  await fastify.register(rateLimit, {
    max: 5,
    timeWindow: "1 minute",
    route: "/uploads"
  });
});

