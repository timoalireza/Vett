/**
 * GDPR Compliance Endpoints
 * 
 * Steps to implement:
 * 1. Copy this file to gdpr.ts (remove .example)
 * 2. Register routes in index.ts
 * 3. Add authentication middleware (users can only access their own data)
 */

import type { FastifyInstance, FastifyRequest } from "fastify";
import { db } from "../db/client.js";
import { analyses, users, collections, feedback } from "../db/schema.js";
import { eq } from "drizzle-orm";

export async function registerGDPRRoutes(app: FastifyInstance) {
  // Export user data (GDPR Right to Access)
  app.get("/gdpr/export", async (request: FastifyRequest, reply) => {
    // TODO: Require authentication
    // const userId = request.userId;
    // if (!userId) {
    //   return reply.code(401).send({ error: "Unauthorized" });
    // }

    const userId = (request as any).userId; // Temporary - replace with real auth

    if (!userId) {
      return reply.code(401).send({ error: "User ID required" });
    }

    // Fetch user data
    const userData = {
      user: await db.query.users.findFirst({
        where: eq(users.id, userId)
      }),
      analyses: await db.query.analyses.findMany({
        where: eq(analyses.userId, userId)
      }),
      collections: await db.query.collections.findMany({
        where: eq(collections.userId, userId)
      }),
      feedback: await db.query.feedback.findMany({
        where: eq(feedback.userId, userId)
      })
    };

    return {
      exportedAt: new Date().toISOString(),
      data: userData
    };
  });

  // Delete user data (GDPR Right to Erasure)
  app.delete("/gdpr/delete", async (request: FastifyRequest, reply) => {
    // TODO: Require authentication
    const userId = (request as any).userId; // Temporary - replace with real auth

    if (!userId) {
      return reply.code(401).send({ error: "User ID required" });
    }

    // Delete user data (cascade deletes will handle related records)
    await db.delete(users).where(eq(users.id, userId));

    return {
      deletedAt: new Date().toISOString(),
      message: "User data deleted successfully"
    };
  });
}

